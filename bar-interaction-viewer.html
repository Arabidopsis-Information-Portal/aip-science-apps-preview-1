<meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script type="text/javascript" src="/cdn/cytoscape.js-2.0.4/cytoscape.min.js"></script>
    <script type="text/javascript" src="/cdn/cytoscape.js-2.0.4/arbor.js"></script>

    <style type="text/css">
        body { 
          font: 14px helvetica neue, helvetica, arial, sans-serif;
        }
        
        #cy {
          height: 600px;
          position: relative;
        }
        
        .warning, .error {
          border: 1px solid;
          margin: 10px 0px;
          padding: 15px 10px 15px 50px;
          background-repeat: no-repeat;
          background-position: 10px center;
        }
        
        .warning {
          color: #9F6000;
          background-color: #FEEFB3;
        }
        
        .error {
          color: #D8000C;
          background-color: #FFBABA;
        }
    </style>
    <h1>Enter a gene name to see its protein-protein interactions</h1>
    <p>Query (Any gene name or AGI ID, e.g. ASK1, AT1G10940, AT3G62980):</p>
    <form id="geneForm">
    	<input type="text" name="gene" id="gene" value="AT3G62980" />
    	<button type="button" class="btn btn-success"id="geneSubmit">Submit</button>
    	<button type="button" class="btn btn-danger"id="clearGraph">Clear</button>
	</form>
	<div id="cy" class="hidden"></div>
	<div class="result"></div>
	<div><p>Data & web services provided by The Bio-Analytic Resource for Plant Biology (BAR): <a href="http://bar.utoronto.ca/webservices" target="_blank">http://bar.utoronto.ca/webservices</a>/</p></div> 
    
<script type="text/javascript">
jQuery(function($){

//    $(".portlet-maximize").click(function () {
//    });
	
    var loadCy = function(elements) {
    
 		$('#cy').removeClass('hidden');   
		$('#cy').cytoscape({
		layout: { name: "arbor",
			liveUpdate: true,
			maxSimulationTime: 4000,
			padding: [50,50,50,50],
			simulationBounds: undefined,
			ungrabifyWhileSimulating: true,
			repulsion: undefined,
			stiffness: undefined,
			friction: undefined,
			gravity: true,
			fps: undefined,
			precision: undefined,
			nodeMass: undefined, 
			edgeLength: undefined,
			stepSize: 1,
			stableEnergy: function( energy ){
				var e = energy; 
				return (e.max <= 0.5) || (e.mean <= 0.3);
			}
    	  },
		  style: cytoscape.stylesheet()
			.selector('node')
			  .css({
				'content': 'data(name)',
				'text-valign': 'center',
				'color': 'white',
				'text-outline-width': 2,
				'text-outline-color': '#888'
			  })
			.selector('edge')
			  .css({
				'target-arrow-shape': 'triangle'
			  })
			.selector(':selected')
			  .css({
				'background-color': 'black',
				'line-color': 'black',
				'target-arrow-color': 'black',
				'source-arrow-color': 'black'
			  })
			.selector('.faded')
			  .css({
				'opacity': 0.25,
				'text-opacity': 0
			  }),
  
		  elements: elements,
  
		  ready: function(){
			window.cy = this;
	
			// giddy up...
	
			cy.elements().unselectify();
	
			cy.on('tap', 'node', function(e){
			  var node = e.cyTarget; 
			  var neighborhood = node.neighborhood().add(node);
	  
			  cy.elements().addClass('faded');
			  neighborhood.removeClass('faded');
			});
	
			cy.on('tap', function(e){
			  if( e.cyTarget === cy ){
				cy.elements().removeClass('faded');
			  }
			});
		  },
		  
		  
		}); 
    } //end loadCy()

    $("#clearGraph").click(function() {
        $("#cy").addClass('hidden');
        $("#gene").val('');
    });


	$("#geneSubmit").click(function(e){	
	    var nodes = [];
		var proteins = [];
		var edges = [];
		var elements = {};
		var gene = $("#gene").val();
		var url = "/apiproxy/BARClient/"+$("#gene").val();
		$(".result" ).removeClass("alert alert-danger");

		
		//various failures to load the gene data call this function
		var ajaxFail = function () {
			$(".result" ).addClass("alert alert-danger");
			$( ".result" ).html( "We could not load the gene data from " + url );
		};
		
		if(gene.length > 0) {
			//perform ajax GET
			$.get( url, 
			function( data ) { //success!
			  if(data.length <= 0) { ajaxFail(); }
			  else {
				  data = data.split("\n");
				  for(var i=0; i< data.length; i++) {
					var line = data[i].split("\t");				  	
				  	if(line[0].length > 0) {
				  	  var p1 = line[0].replace(/tair:/,"");
				  	  var p2 = line[1].replace(/tair:/,"");
				  	  
				  	  //add to "nodes" proteins array if not already in there
				  	  if(proteins.indexOf(p1) == -1) {
				  	  	proteins.push(p1);
				  	    nodes.push({data: {id: p1, name: p1}});
				  	  } else { console.log('not added');}
				  	  if(proteins.indexOf(p2) == -1) {
				  	  	proteins.push(p2);
				  	    nodes.push({data: {id: p2, name: p2}});
				  	  } else { console.log('not added');}
				  	  
				  	  //add the interaction
				  	  edges.push({data:{ source: p1 , target: p2 }});
				  	}
				  }

				  elements = {nodes: nodes, edges: edges};
				  //console.log(JSON.stringify(elements));
				  
				  loadCy(elements);

			  }
			}, "text").fail(ajaxFail); //do failure stuff
		} else {
			alert("You must enter a gene first.");
			return;
		}		
	});
});
</script>